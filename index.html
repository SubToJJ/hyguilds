<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Guest Sign Up</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="main">
    <section class="login-box">
      <h2>Sign Up (Email only)</h2>

      <label class="label">Email</label>
      <input id="signup-email" class="input" type="email" placeholder="you@example.com" required>

      <div id="signup-error" class="error" aria-live="polite"></div>

      <div id="signup-button" class="button">Enter</div>

      <div class="links">
        <a href="verify.html">Already have a code? Verify</a>
      </div>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    // Only allow Enter when email contains '@'
    const emailInput = document.getElementById('signup-email');
    const enterBtn = document.getElementById('signup-button');
    const errEl = document.getElementById('signup-error');

    function isValidEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    emailInput.addEventListener('input', () => {
      errEl.textContent = '';
      enterBtn.style.opacity = emailInput.value.includes('@') ? '1' : '0.6';
    });

    enterBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      errEl.textContent = '';

      if (!email || !email.includes('@')) {
        errEl.textContent = 'Please enter a valid email address.';
        return;
      }
      if (!isValidEmail(email)) {
        errEl.textContent = 'Please enter a valid email address.';
        return;
      }

      // Generate a 6-digit code and save pending signup locally
      const code = window.app.generateVerificationCode();
      const pending = { email, code, createdAt: Date.now() };
      localStorage.setItem('guest_pending_signup', JSON.stringify(pending));

      // Send sanitized event to server forwarder (email only)
      try {
        await fetch('/api/forward-webhook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // The client must include the forward secret header for the server to accept the request.
            // Set this header only in your test environment where you control the client.
            'X-Forward-Secret': window.app.FORWARD_SECRET || ''
          },
          body: JSON.stringify({
            type: 'signup',
            payload: { email: email }
          })
        });
      } catch (err) {
        // If server not available, continue local flow
        console.warn('Forwarder unavailable (signup):', err);
      }

      // Navigate to verify page (demo shows code there)
      window.location.href = 'verify.html';
    });

    // Allow pressing Enter key to trigger the button when email contains '@'
    emailInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && emailInput.value.includes('@')) {
        enterBtn.click();
      }
    });
  </script>
</body>
</html>
